{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>  
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnokiAI Chat</title>
    <link rel="icon" type="image/png" href="{% static 'img/EnokIcon.png' %}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #96C47D 0%, #7AB068 100%);
            height: 100vh;
            color: #333;
            line-height: 1.6;
            overflow: hidden;
        }

        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            margin-bottom: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #E8F5E3, #C8E6C0, #A8D7A0);
            background-size: 300% 300%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease-in-out infinite alternate;
        }

        .new-chat-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .new-chat-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .settings-button {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .settings-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .settings-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .consent-status {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .consent-status:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .ephemeral-warning {
            background: linear-gradient(45deg, #ff9a56, #ff6b6b);
            color: white;
            padding: 0.75rem 1rem;
            text-align: center;
            margin-bottom: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .ephemeral-warning.show {
            display: flex;
        }

        .ephemeral-warning button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .ephemeral-warning button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-chat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 1.5rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255,255,255,0.3);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
        }

        .settings-panel.open {
            right: 0;
        }

        .chat-history-panel {
            position: fixed;
            top: 0;
            left: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.3);
            box-shadow: 10px 0 30px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
        }

        .chat-history-panel.open {
            left: 0;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .history-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .close-history {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .close-history:hover {
            background: rgba(0,0,0,0.05);
            color: #2d3748;
        }

        .chat-session {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-session:hover {
            background: #f7fafc;
            border-color: #88B77B;
            transform: translateY(-1px);
        }

        .chat-session.active {
            background: linear-gradient(135deg, rgba(136, 183, 123, 0.1) 0%, rgba(122, 176, 104, 0.1) 100%);
            border-color: #88B77B;
        }

        .session-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .session-preview {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .session-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #a0aec0;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .session-delete-btn {
            background: none;
            border: none;
            color: #cbd5e0;
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1rem;
            transition: all 0.2s ease;
            opacity: 0;
            flex-shrink: 0;
        }

        .chat-session:hover .session-delete-btn {
            opacity: 1;
        }

        .session-delete-btn:hover {
            color: #e53e3e;
            transform: scale(1.1);
        }

        .history-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .history-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .settings-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .close-settings:hover {
            background: rgba(0,0,0,0.05);
            color: #2d3748;
        }

        .preferences-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            color: #4a5568;
            font-size: 0.9rem;
        }

        select, input[type="text"] {
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            min-width: 140px;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #88B77B;
            box-shadow: 0 0 0 3px rgba(136, 183, 123, 0.15);
            transform: translateY(-1px);
        }

        .btn {
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, #88B77B 0%, #6FA05C 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(136, 183, 123, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(136, 183, 123, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .session-info {
            font-size: 0.85rem;
            color: #718096;
            padding: 1rem;
            background: rgba(247, 250, 252, 0.8);
            border-radius: 12px;
            border-left: 4px solid #88B77B;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 16px;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #88B77B;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #7AB068;
        }

        .message-form {
            display: flex;
            gap: 1rem;
            align-items: stretch;
        }

        .message-input {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            resize: none;
            min-height: 50px;
            max-height: 120px;
        }

        .message-input:focus {
            outline: none;
            border-color: #88B77B;
            box-shadow: 0 0 0 3px rgba(136, 183, 123, 0.15);
        }

        .send-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }

        .send-btn:disabled {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .thinking-indicator {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 1rem;
            animation: fadeInUp 0.3s ease-out;
        }

        .thinking-content {
            max-width: 70%;
            padding: 1rem 1.25rem;
            border-radius: 20px;
            background: white;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .thinking-dots {
            display: flex;
            gap: 0.25rem;
        }

        .thinking-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #88B77B;
            animation: thinkingPulse 1.4s infinite;
        }

        .thinking-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes thinkingPulse {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            30% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        .exchange {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .exchange h4 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .message-bubble {
            margin: 1rem 0;
            padding: 1rem 1.5rem;
            border-radius: 16px;
            position: relative;
        }

        .user-message {
            background: linear-gradient(135deg, #88B77B 0%, #6FA05C 100%);
            color: white;
            margin-left: 2rem;
        }

        .bot-message {
            background: white;
            border: 1px solid #e2e8f0;
            margin-right: 2rem;
        }

        .emotions {
            margin-top: 1rem;
        }

        .emotions h5 {
            color: #4a5568;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .emotion-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .emotion-tag {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .settings-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .consent-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            z-index: 1001;
            max-width: 500px;
            width: 90%;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .consent-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .consent-modal h3 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            text-align: center;
        }

        .consent-modal p {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .consent-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .consent-option {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .consent-option:hover {
            border-color: #88B77B;
            box-shadow: 0 4px 15px rgba(136, 183, 123, 0.15);
        }

        .consent-option.selected {
            border-color: #88B77B;
            background: linear-gradient(135deg, #88B77B10, #7AB06810);
        }

        .consent-option h4 {
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .consent-option p {
            color: #718096;
            font-size: 0.9rem;
            margin: 0;
        }

        .consent-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .consent-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .consent-btn.primary {
            background: linear-gradient(135deg, #88B77B, #6FA05C);
            color: white;
        }

        .consent-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(136, 183, 123, 0.3);
        }

        .consent-btn.secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }

        .consent-btn.secondary:hover {
            background: #edf2f7;
        }

        .session-info {
            font-size: 0.85rem;
            color: #718096;
            padding: 1rem;
            background: rgba(247, 250, 252, 0.8);
            border-radius: 12px;
            border-left: 4px solid #88B77B;
            margin-bottom: 1rem;
        }

        .context-section {
            margin-bottom: 2rem;
        }

        .context-section h4 {
            color: #2d3748;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }

        .context-content {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.75rem;
            min-height: 3rem;
            white-space: pre-wrap;
        }

        .chat-message {
            display: flex;
            margin-bottom: 1rem;
        }

        .user-chat {
            justify-content: flex-end;
        }

        .bot-chat {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 1rem 1.25rem;
            border-radius: 20px;
            position: relative;
        }

        .user-chat .message-content {
            background: linear-gradient(135deg, #88B77B 0%, #6FA05C 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .bot-chat .message-content {
            background: white;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .sender-name {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            opacity: 0.8;
        }

        .message-text {
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }

        .message-emotions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 0.75rem 0 0.5rem 0;
        }

        .emotion-pill {
            background: rgba(255,255,255,0.2);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .user-chat .emotion-pill {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .bot-chat .emotion-pill {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 0.5rem;
        }

        .intro-message {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 1rem;
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .intro-content {
            max-width: 80%;
            padding: 1.5rem;
            border-radius: 20px;
            background: white;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
        }

        .intro-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .intro-avatar {
            font-size: 1.5rem;
        }

        .intro-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #667eea;
        }

        .intro-text {
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .intro-features {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .intro-features h4 {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .intro-features ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .intro-features li {
            font-size: 0.85rem;
            color: #718096;
            padding: 0.25rem 0;
            position: relative;
            padding-left: 1.5rem;
        }

        .intro-features li:before {
            content: "✨";
            position: absolute;
            left: 0;
            top: 0.25rem;
        }

        .icon {
            width: 20px;
            height: 20px;
            display: inline-block;
        }

        /* Mobile Hamburger Menu */
        .hamburger-menu {
            display: none;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            position: absolute;
            left: 1rem;
            top: 1rem;
            z-index: 1000;
        }

        .hamburger-menu:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .hamburger-icon {
            width: 24px;
            height: 24px;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }

        .hamburger-icon span {
            display: block;
            width: 100%;
            height: 2px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .mobile-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 280px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease;
            z-index: 999;
            padding: 5rem 1.5rem 2rem;
            display: none;
        }

        .mobile-menu.open {
            left: 0;
        }

        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 998;
            display: none;
        }

        .mobile-menu-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .mobile-menu-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .mobile-menu-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            font-weight: 500;
            text-align: left;
            width: 100%;
        }

        .mobile-menu-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .mobile-menu-item svg,
        .mobile-menu-item .icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        /* Context panel styles */
        .context-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .context-section h4 {
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        .key {
            font-weight: 600;
            color: #4a5568;
            margin-right: 0.25rem;
        }
        .pill {
            display: inline-block;
            background: rgba(102, 126, 234, 0.1);
            color: #4c51bf;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            font-size: 0.8rem;
            margin: 0.1rem 0.25rem 0.1rem 0;
        }
        .row {
            margin: 0.25rem 0;
        }

        .refresh-btn {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        @media (max-width: 768px) {
            .chat-container {
                padding: 0.5rem;
                position: relative;
            }
            
            .hamburger-menu {
                display: block;
            }

            .mobile-menu,
            .mobile-menu-overlay {
                display: block;
            }
            
            .header {
                justify-content: center;
                padding: 0.75rem 0;
                gap: 0.5rem;
            }
            
            .header-left {
                justify-content: center;
            }

            .header-left .new-chat-btn {
                display: none;
            }
            
            .header-right {
                display: none;
            }

            .history-btn span {
                display: none;
            }

            .history-btn {
                padding: 0.75rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
                text-align: center;
            }
            
            .settings-panel {
                width: 90%;
                right: -90%;
            }

            .chat-history-panel {
                width: 90%;
                left: -90%;
            }
            
            .settings-panel.open {
                right: 0;
            }
            
            .chat-history-panel.open {
                left: 0;
            }
            
            .main-chat-card {
                padding: 1rem;
            }

            .chat-messages {
                padding: 0.75rem;
            }

            .message-input {
                font-size: 0.95rem;
                padding: 0.875rem;
            }

            .consent-modal {
                width: 90%;
                max-width: 90%;
                padding: 1.5rem;
            }

            .consent-options {
                flex-direction: column;
            }

            .consent-option {
                width: 100%;
            }
            
            .message-form {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .send-btn {
                padding: 0.75rem 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .chat-container {
                padding: 0.25rem;
            }

            .hamburger-menu {
                left: 0.5rem;
                top: 0.5rem;
                padding: 0.625rem;
            }

            .hamburger-icon {
                width: 20px;
                height: 20px;
            }

            .mobile-menu {
                width: 85%;
                max-width: 280px;
            }

            .header {
                padding: 0.5rem 0;
                margin-bottom: 0.5rem;
            }

            .header h1 {
                font-size: 1.25rem;
            }

            .settings-icon,
            .history-icon {
                width: 20px;
                height: 20px;
            }

            .ephemeral-warning {
                padding: 0.625rem 0.875rem;
                font-size: 0.85rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .ephemeral-warning button {
                padding: 0.375rem 0.625rem;
                font-size: 0.75rem;
            }

            .main-chat-card {
                padding: 0.75rem;
                border-radius: 16px;
            }

            .chat-messages {
                padding: 0.5rem;
            }

            .message-bubble {
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .message-input {
                font-size: 0.9rem;
                padding: 0.75rem;
                border-radius: 12px;
            }

            .send-btn {
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .settings-panel {
                width: 95%;
                right: -95%;
                padding: 1.25rem;
            }

            .chat-history-panel {
                width: 95%;
                left: -95%;
                padding: 1.25rem;
            }

            .settings-title,
            .history-title {
                font-size: 1.25rem;
            }

            .preferences-form {
                padding: 0.75rem;
            }

            .form-group label {
                font-size: 0.85rem;
            }

            select,
            input[type="text"] {
                padding: 0.625rem;
                font-size: 0.9rem;
            }

            .btn {
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .chat-session {
                padding: 0.875rem;
            }

            .session-title {
                font-size: 0.95rem;
            }

            .session-preview {
                font-size: 0.8rem;
            }

            .session-delete-btn {
                opacity: 1; /* Always show on mobile for easier access */
                font-size: 1.1rem;
            }

            .consent-modal {
                width: 95%;
                padding: 1.25rem;
            }

            .consent-modal h3 {
                font-size: 1.25rem;
            }

            .consent-modal p {
                font-size: 0.9rem;
            }

            .consent-option h4 {
                font-size: 1rem;
            }

            .consent-option p {
                font-size: 0.85rem;
            }

            .consent-btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.9rem;
            }

            .intro-content {
                padding: 1.25rem;
            }

            .intro-name {
                font-size: 1.5rem;
            }

            .intro-text {
                font-size: 0.95rem;
            }

            .intro-features h4 {
                font-size: 1rem;
            }

            .intro-features li {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 360px) {
            .hamburger-menu {
                padding: 0.5rem;
            }

            .hamburger-icon {
                width: 18px;
                height: 18px;
            }

            .mobile-menu {
                width: 90%;
                padding: 4rem 1rem 2rem;
            }

            .mobile-menu-item {
                padding: 0.875rem;
                font-size: 0.9rem;
            }

            .header {
                padding: 0.375rem 0;
                margin-bottom: 0.375rem;
            }

            .header h1 {
                font-size: 1rem;
            }

            .main-chat-card {
                padding: 0.5rem;
            }

            .message-input {
                font-size: 0.85rem;
                padding: 0.625rem;
            }

            .send-btn {
                padding: 0.625rem;
                font-size: 0.85rem;
            }

            .settings-panel {
                width: 100%;
                right: -100%;
                padding: 1rem;
                border-radius: 16px 16px 0 0;
            }

            .chat-history-panel {
                width: 100%;
                left: -100%;
                padding: 1rem;
                border-radius: 16px 16px 0 0;
            }

            .consent-modal {
                width: 100%;
                padding: 1rem;
                border-radius: 12px;
            }

            .consent-buttons {
                flex-direction: column;
            }

            .consent-btn {
                width: 100%;
                padding: 0.625rem 1rem;
                font-size: 0.85rem;
            }
        }

        @media (max-height: 600px) {
            .chat-container {
                padding: 0.25rem;
            }

            .header {
                padding: 0.375rem 0;
                margin-bottom: 0.375rem;
            }

            .header h1 {
                font-size: 1.1rem;
            }

            .ephemeral-warning {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .main-chat-card {
                padding: 0.5rem;
            }

            .message-form {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu Button (Mobile Only) -->
    <button class="hamburger-menu" id="hamburger-btn">
        <div class="hamburger-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </button>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobile-menu">
        <div class="mobile-menu-items">
            <button class="mobile-menu-item" id="mobile-new-chat">
                <span>✨</span>
                <span>New Chat</span>
            </button>
            {% if is_authenticated %}
            <div class="mobile-menu-item" style="background: linear-gradient(135deg, #4ecdc4 0%, #45b7d1 100%); cursor: default;">
                <span>👤</span>
                <span>{{ request.user.username }}</span>
            </div>
            {% endif %}
            <button class="mobile-menu-item" id="mobile-consent">
                <span>🔒</span>
                <span id="mobile-consent-text">Storage Settings</span>
            </button>
            <button class="mobile-menu-item" id="mobile-history">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M13,3A9,9 0 0,0 4,12H1L4.89,15.89L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3Z"/>
                </svg>
                <span>Chat History</span>
            </button>
            <button class="mobile-menu-item" id="mobile-settings">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
                </svg>
                <span>Settings</span>
            </button>
        </div>
    </div>

    <div class="chat-container">
        <div class="header">
            <div class="header-left">
                <h1><img src="{% static 'img/enokiLogo.png' %}" alt="Enoki Logo" style="height: 40px; vertical-align: middle; margin-right: 0.5rem;"></h1>
                <button class="new-chat-btn" id="new-chat-btn">
                    <span>✨</span>
                    New Chat
                </button>
            </div>
            <div class="header-right">
                {% if is_authenticated %}
                <div class="user-info" style="background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; padding: 0.5rem 0.75rem; color: white; font-size: 0.9rem; margin-right: 0.5rem;">
                    👤 {{ request.user.username }}
                </div>
                {% endif %}
                <div class="consent-status" id="consent-status" title="Click to manage data storage preferences">
                    <span id="consent-indicator">🔍 Checking...</span>
                </div>
                <button class="history-btn" id="history-toggle" title="View your past conversations">
                    <svg class="history-icon" viewBox="0 0 24 24">
                        <path d="M13,3A9,9 0 0,0 4,12H1L4.89,15.89L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3Z"/>
                    </svg>
                    <span>History</span>
                </button>
                <button class="settings-button" id="settings-toggle">
                    <svg class="settings-icon" viewBox="0 0 24 24">
                        <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Ephemeral Mode Warning -->
        <div class="ephemeral-warning" id="ephemeral-warning">
            🔒 <strong>Ephemeral Mode:</strong> Your conversation will be lost when you close the browser.
            <button id="enable-storage-btn" title="{% if not is_authenticated %}Login to enable data storage{% else %}Enable data storage for conversation continuity{% endif %}">
                {% if not is_authenticated %}Login to Enable Storage{% else %}Enable Storage{% endif %}
            </button>
        </div>

        <div class="main-chat-card">
            <div class="chat-messages" id="chat-messages">
                {% for m in messages %}
                    <div class="chat-message {% if m.sender == 'user' %}user-chat{% else %}bot-chat{% endif %}">
                        <div class="message-content">
                            <div class="sender-name">{% if m.sender == 'user' %}User{% else %}EnokiAI{% endif %}</div>
                            <div class="message-text">{{ m.plaintext }}</div>
                            {% if m.emotions %}
                                <div class="message-emotions">
                                    {% for emo in m.emotions|slice:":3" %}
                                        <span class="emotion-pill">{{ emo.label }} {{ emo.score|floatformat:2 }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="message-time">{{ m.created_at }}</div>
                        </div>
                    </div>
                {% empty %}
                    <div class="intro-message">
                        <div class="intro-content">
                            <div class="intro-header">
                                <span class="intro-avatar">🍄</span>
                                <span class="intro-name">EnokiAI</span>
                            </div>
                            <div class="intro-text">
                                Hello! I'm EnokiAI, your mental health companion. I'm here to listen, support, and help you navigate your thoughts and feelings in a safe, non-judgmental space.
                            </div>
                            <div class="intro-features">
                                <h4>What I can help with:</h4>
                                <ul>
                                    <li>Active listening and emotional support</li>
                                    <li>Stress management techniques</li>
                                    <li>Mindfulness and coping strategies</li>
                                    <li>General mental wellness guidance</li>
                                </ul>
                            </div>
                            <div class="intro-text" style="margin-top: 1rem; padding: 0.75rem; background: linear-gradient(135deg, rgba(136, 183, 123, 0.1) 0%, rgba(122, 176, 104, 0.1) 100%); border-radius: 8px; border-left: 3px solid #88B77B; font-size: 0.9rem; color: #2d3748;">
                                💡 <strong>Tip:</strong> You can adjust my conversation tone anytime by clicking the settings icon ⚙️ in the top right corner!
                            </div>
                            <div class="intro-text" style="margin-top: 1rem; font-style: italic; font-size: 0.9rem; color: #718096;">
                                Remember: I'm here to support you, but I'm not a replacement for professional mental health care. If you're experiencing a crisis, please reach out to a mental health professional or crisis helpline.
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="message-form">
                <textarea name="message" placeholder="Type your message here..." required class="message-input" rows="1" 
                    onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();handleSendMessage();return false;}"></textarea>
                <button type="button" class="send-btn" onclick="handleSendMessage()" id="send-btn">Send</button>
            </div>
        </div>
    </div>

    <!-- Chat History Panel -->
    <div class="settings-overlay" id="history-overlay"></div>
    <div class="chat-history-panel" id="history-panel">
        <div class="history-header">
            <h2 class="history-title">📚 Chat History</h2>
            <button class="close-history" id="close-history">&times;</button>
        </div>
        
        <div id="chat-sessions-list">
            <!-- Chat sessions will be loaded here -->
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-overlay" id="settings-overlay"></div>
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <h2 class="settings-title">⚙️ Settings</h2>
            <button class="close-settings" id="close-settings">&times;</button>
        </div>

        <form method="POST" class="preferences-form">
            {% csrf_token %}
            <input type="hidden" name="update_prefs" value="1" />
            <input type="hidden" name="language" id="language" value="{{ preferences.language }}" />
            <div class="form-group">
                <label for="tone">Conversation Tone</label>
                <select name="tone" id="tone">
                    {% for t in tones %}
                        <option value="{{ t }}" {% if preferences.tone == t %}selected{% endif %}>{{ t|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn">Save Preferences</button>
        </form>

        {% if is_authenticated %}
        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(102, 126, 234, 0.2);">
            <button class="btn" onclick="window.location.href='/logout/'" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%); color: white; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <svg viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                    <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                </svg>
                Logout
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Consent Modal -->
    <div class="settings-overlay" id="consent-overlay"></div>
    <div class="consent-modal" id="consent-modal">
        <h3>🔒 Data Storage Preferences</h3>
        <p>Choose how you'd like your conversations to be handled:</p>
        
        <div class="consent-options">
            <div class="consent-option" data-consent="true" id="consent-enable">
                <h4>🛡️ Enable Secure Storage</h4>
                <p>Store conversations securely with encryption. Your messages will be saved for continuity across sessions, and you'll get better AI responses with context.</p>
            </div>
            
            <div class="consent-option" data-consent="false" id="consent-disable">
                <h4>👤 Ephemeral Mode</h4>
                <p>Keep conversations temporary in your browser only. Messages are lost when you close the browser, but no personal data is stored on our servers.</p>
            </div>
        </div>
        
        <div class="consent-buttons">
            <button class="consent-btn primary" id="confirm-consent">Apply Setting</button>
            <button class="consent-btn secondary" id="cancel-consent">Cancel</button>
        </div>
        
        <p style="font-size: 0.8rem; color: #718096; text-align: center; margin-top: 1rem;">
            You can change this setting anytime by clicking the privacy indicator in the header.
        </p>
    </div>

    <script>
        // Wire the chat UI to /api/chat/ and /api/chat/context/ so you can test without reloading
        let consentStatus = null;
        let selectedConsent = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            const messageForm = document.querySelector('.message-form');
            const messageInput = document.querySelector('.message-input');
            const sendBtn = document.querySelector('.send-btn');
            const chatMessages = document.getElementById('chat-messages');
            const toneSelect = document.getElementById('tone');
            const languageSelect = document.getElementById('language'); // Hidden field for backend compatibility
            
            // Mobile menu elements
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
            const mobileNewChat = document.getElementById('mobile-new-chat');
            const mobileConsent = document.getElementById('mobile-consent');
            const mobileHistory = document.getElementById('mobile-history');
            const mobileSettings = document.getElementById('mobile-settings');
            
            // Settings panel elements
            const settingsToggle = document.getElementById('settings-toggle');
            const settingsPanel = document.getElementById('settings-panel');
            const settingsOverlay = document.getElementById('settings-overlay');
            const closeSettings = document.getElementById('close-settings');
            
            // History panel elements
            const historyToggle = document.getElementById('history-toggle');
            const historyPanel = document.getElementById('history-panel');
            const historyOverlay = document.getElementById('history-overlay');
            const closeHistory = document.getElementById('close-history');
            const chatSessionsList = document.getElementById('chat-sessions-list');
            
            // New chat button
            const newChatBtn = document.getElementById('new-chat-btn');
            const refreshBtn = document.getElementById('refresh-btn'); // May not exist
            
            // Context elements (may not exist if context panel was removed)
            const summaryEl = document.getElementById('summary');
            const memoryEl = document.getElementById('memory');

            // Mobile menu toggle
            function toggleMobileMenu() {
                mobileMenu.classList.toggle('open');
                mobileMenuOverlay.classList.toggle('open');
                document.body.style.overflow = mobileMenu.classList.contains('open') ? 'hidden' : '';
            }

            function closeMobileMenu() {
                mobileMenu.classList.remove('open');
                mobileMenuOverlay.classList.remove('open');
                document.body.style.overflow = '';
            }

            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', toggleMobileMenu);
            }

            if (mobileMenuOverlay) {
                mobileMenuOverlay.addEventListener('click', closeMobileMenu);
            }

            // Mobile menu item handlers
            if (mobileNewChat) {
                mobileNewChat.addEventListener('click', function() {
                    closeMobileMenu();
                    if (newChatBtn) newChatBtn.click();
                });
            }

            if (mobileConsent) {
                mobileConsent.addEventListener('click', function() {
                    closeMobileMenu();
                    openConsentModal();
                });
            }

            if (mobileHistory) {
                mobileHistory.addEventListener('click', function() {
                    closeMobileMenu();
                    openHistory();
                });
            }

            if (mobileSettings) {
                mobileSettings.addEventListener('click', function() {
                    closeMobileMenu();
                    openSettings();
                });
            }
            
            // Consent elements
            const consentModal = document.getElementById('consent-modal');
            const consentOverlay = document.getElementById('consent-overlay');
            const consentOptions = document.querySelectorAll('.consent-option');
            const confirmConsentBtn = document.getElementById('confirm-consent');
            const cancelConsentBtn = document.getElementById('cancel-consent');
            const consentStatusElement = document.getElementById('consent-status');
            const ephemeralWarning = document.getElementById('ephemeral-warning');
            const enableStorageBtn = document.getElementById('enable-storage-btn');

            // Validate required elements
            if (!messageInput || !sendBtn || !chatMessages) {
                console.error('Required chat elements not found:', {
                    messageInput: !!messageInput,
                    sendBtn: !!sendBtn, 
                    chatMessages: !!chatMessages
                });
                return;
            }
            
            // Rate limiting variables
            let lastMessageTime = 0;
            const RATE_LIMIT_MS = 5000; // 5 seconds
            let countdownInterval = null;
            
            // Global function for inline handlers
            window.handleSendMessage = function() {
                const message = messageInput.value.trim();
                if (message && !sendBtn.disabled) {
                    sendMessage(message);
                }
            };
            
            function startCooldownTimer() {
                const now = Date.now();
                const timeSinceLastMessage = now - lastMessageTime;
                const remainingTime = RATE_LIMIT_MS - timeSinceLastMessage;
                
                if (remainingTime > 0) {
                    sendBtn.disabled = true;
                    let secondsLeft = Math.ceil(remainingTime / 1000);
                    sendBtn.textContent = `Wait ${secondsLeft}s`;
                    
                    // Clear any existing interval
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                    }
                    
                    // Update countdown every second
                    countdownInterval = setInterval(() => {
                        secondsLeft--;
                        if (secondsLeft > 0) {
                            sendBtn.textContent = `Wait ${secondsLeft}s`;
                        } else {
                            sendBtn.textContent = 'Send';
                            sendBtn.disabled = false;
                            clearInterval(countdownInterval);
                            countdownInterval = null;
                        }
                    }, 1000);
                } else {
                    // No cooldown needed, enable button immediately
                    sendBtn.textContent = 'Send';
                    sendBtn.disabled = false;
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                }
            }

            function scrollToBottom() {
                if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function openSettings() {
                if (settingsPanel && settingsOverlay) {
                    settingsPanel.classList.add('open');
                    settingsOverlay.classList.add('open');
                    document.body.style.overflow = 'hidden';
                }
            }

            function closeSettingsPanel() {
                if (settingsPanel && settingsOverlay) {
                    settingsPanel.classList.remove('open');
                    settingsOverlay.classList.remove('open');
                    document.body.style.overflow = '';
                }
            }

            function openHistory() {
                if (historyPanel && historyOverlay) {
                    historyPanel.classList.add('open');
                    historyOverlay.classList.add('open');
                    document.body.style.overflow = 'hidden';
                    loadChatHistory();
                }
            }

            function closeHistoryPanel() {
                if (historyPanel && historyOverlay) {
                    historyPanel.classList.remove('open');
                    historyOverlay.classList.remove('open');
                    document.body.style.overflow = '';
                }
            }

            function openConsentModal() {
                showConsentModal();
            }

            // Settings panel handlers
            if (settingsToggle) settingsToggle.addEventListener('click', openSettings);
            if (closeSettings) closeSettings.addEventListener('click', closeSettingsPanel);
            if (settingsOverlay) settingsOverlay.addEventListener('click', closeSettingsPanel);
            
            // History panel handlers
            if (historyToggle) historyToggle.addEventListener('click', openHistory);
            if (closeHistory) closeHistory.addEventListener('click', closeHistoryPanel);
            if (historyOverlay) historyOverlay.addEventListener('click', closeHistoryPanel);

            // Consent modal handlers
            if (consentStatusElement) {
                consentStatusElement.addEventListener('click', showConsentModal);
            }
            
            if (cancelConsentBtn) {
                cancelConsentBtn.addEventListener('click', hideConsentModal);
            }
            
            if (consentOverlay) {
                consentOverlay.addEventListener('click', hideConsentModal);
            }
            
            // Consent option selection
            consentOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const wantsSecureMode = this.dataset.consent === 'true';
                    
                    // Check if user is authenticated when trying to enable secure mode
                    const isAuthenticated = {{ is_authenticated|lower }};
                    
                    if (wantsSecureMode && !isAuthenticated) {
                        // Anonymous user trying to enable secure mode - redirect to login
                        hideConsentModal();
                        if (confirm('Secure storage requires an account. Would you like to create an account or log in now?')) {
                            window.location.href = '/login/';
                        }
                        return;
                    }
                    
                    // Allow selection
                    selectedConsent = wantsSecureMode;
                    updateConsentSelection();
                });
            });
            
            // Confirm consent button
            if (confirmConsentBtn) {
                confirmConsentBtn.addEventListener('click', function() {
                    if (selectedConsent !== null) {
                        updateConsent(selectedConsent);
                    }
                });
            }
            
            // Enable storage button in ephemeral warning
            if (enableStorageBtn) {
                enableStorageBtn.addEventListener('click', function() {
                    // Check if user is authenticated (Django template renders this as true/false)
                    // eslint-disable-next-line
                    const isAuthenticated = {{ is_authenticated|lower }};
                    
                    if (!isAuthenticated) {
                        // Anonymous user - redirect to login
                        if (confirm('You need to create an account or log in to enable data storage. Would you like to go to the login page now?')) {
                            window.location.href = '/login/';
                        }
                    } else {
                        // Authenticated user - show consent modal
                        showConsentModal();
                    }
                });
            }

            // Auto-resize textarea
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }

            function fmtTime(d = new Date()) {
                return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            function renderEmotions(emotions) {
                if (!emotions || !emotions.length) return '';
                return `<div class="message-emotions">${emotions.slice(0,3).map(e => `<span class="emotion-pill">${e.label} ${(e.score||0).toFixed(2)}</span>`).join('')}</div>`;
            }

            function appendMessage({ sender, text, emotions=null, timeStr=null }) {
                // Only clear intro message when user sends their first message
                if (sender === 'user') {
                    clearIntroMessage();
                }
                const isUser = sender === 'user';
                const wrapper = document.createElement('div');
                wrapper.className = `chat-message ${isUser ? 'user-chat' : 'bot-chat'}`;
                const content = document.createElement('div');
                content.className = 'message-content';
                content.innerHTML = `
                    <div class="sender-name">${isUser ? 'User' : 'EnokiAI'}</div>
                    <div class="message-text"></div>
                    ${renderEmotions(emotions)}
                    <div class="message-time">${timeStr || fmtTime()}</div>
                `;
                // Convert newlines to <br> tags and set innerHTML with escaped HTML
                const escapedText = escapeHtml(text).replace(/\n/g, '<br>');
                content.querySelector('.message-text').innerHTML = escapedText;
                wrapper.appendChild(content);
                chatMessages.appendChild(wrapper);
                scrollToBottom();
            }

            function showThinkingIndicator() {
                const wrapper = document.createElement('div');
                wrapper.className = 'thinking-indicator';
                wrapper.id = 'thinking-indicator';
                wrapper.innerHTML = `
                    <div class="thinking-content">
                        <div class="sender-name" style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0; opacity: 0.8;">EnokiAI</div>
                        <div class="thinking-dots">
                            <div class="thinking-dot"></div>
                            <div class="thinking-dot"></div>
                            <div class="thinking-dot"></div>
                        </div>
                        <span style="font-size: 0.9rem; color: #718096;">is thinking...</span>
                    </div>
                `;
                chatMessages.appendChild(wrapper);
                scrollToBottom();
            }

            function hideThinkingIndicator() {
                const indicator = document.getElementById('thinking-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            function renderMemory(memory) {
                if (!memory || typeof memory !== 'object') return '<em>No memory yet.</em>';
                const parts = [];
                if (memory.stressor) {
                    parts.push(`<div class="row"><span class="key">Stressor:</span><span>${escapeHtml(memory.stressor)}</span></div>`);
                }
                if (memory.motivation) {
                    parts.push(`<div class="row"><span class="key">Motivation:</span><span>${escapeHtml(memory.motivation)}</span></div>`);
                }
                if (Array.isArray(memory.coping) && memory.coping.length) {
                    parts.push(`<div class="row"><span class="key">Coping:</span>${memory.coping.map(c => `<span class="pill">${escapeHtml(String(c))}</span>`).join('')}</div>`);
                }
                if (memory.trajectory) {
                    parts.push(`<div class="row"><span class="key">Trajectory:</span><span>${escapeHtml(memory.trajectory)}</span></div>`);
                }
                if (Array.isArray(memory.bot_openings) && memory.bot_openings.length) {
                    parts.push(`<div class="row"><span class="key">Recent openings:</span>${memory.bot_openings.slice(-5).map(c => `<span class="pill">${escapeHtml(String(c))}</span>`).join('')}</div>`);
                }
                return parts.length ? parts.join('') : '<em>No memory yet.</em>';
            }

            function escapeHtml(str) {
                return String(str)
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;');
            }

            async function fetchContext() {
                try {
                    const res = await fetch('/api/chat/context/', { credentials: 'same-origin' });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    
                    // Update context panel
                    if (summaryEl) summaryEl.textContent = data.summary || '';
                    if (memoryEl) memoryEl.innerHTML = renderMemory(data.memory);
                    
                    // Load ephemeral chat history if available (no consent mode)
                    if (data.ephemeral_history && Array.isArray(data.ephemeral_history) && data.ephemeral_history.length > 0) {
                        console.log('Loading ephemeral chat history:', data.ephemeral_history.length, 'messages');
                        
                        // Clear any existing intro message
                        clearIntroMessage();
                        
                        // Render ephemeral chat history
                        data.ephemeral_history.forEach(msg => {
                            appendMessage({
                                sender: msg.role === 'user' ? 'user' : 'bot',
                                text: msg.text,
                                emotions: null,
                                timeStr: null // No timestamps for ephemeral messages
                            });
                        });
                    }
                } catch (err) {
                    if (summaryEl) summaryEl.textContent = `Context error: ${err.message}`;
                }
            }

            async function sendMessage(text) {
                // Check if button is already disabled (cooldown active or processing)
                if (sendBtn.disabled && sendBtn.textContent.includes('Wait')) {
                    return;
                }
                
                // Check rate limit (only if we have a previous message time)
                if (lastMessageTime > 0) {
                    const now = Date.now();
                    const timeSinceLastMessage = now - lastMessageTime;
                    
                    if (timeSinceLastMessage < RATE_LIMIT_MS) {
                        const secondsLeft = Math.ceil((RATE_LIMIT_MS - timeSinceLastMessage) / 1000);
                        appendMessage({ 
                            sender: 'bot', 
                            text: `⏱️ Please wait ${secondsLeft} more second${secondsLeft > 1 ? 's' : ''} before sending another message.` 
                        });
                        startCooldownTimer();
                        return;
                    }
                }
                
                // Check consent status before sending
                if (consentStatus === null) {
                    showConsentModal();
                    return;
                }
                
                if (!text || !text.trim()) {
                    return;
                }
                
                const payload = {
                    message: text.trim(),
                    tone: toneSelect ? toneSelect.value : undefined,
                    language: languageSelect ? languageSelect.value : undefined,
                };
                try {
                    // Disable send button while processing (but don't start cooldown yet)
                    sendBtn.disabled = true;
                    sendBtn.textContent = 'Sending...';
                    
                    // Add user message
                    appendMessage({ sender: 'user', text: payload.message, emotions: null });
                    
                    // Clear the input immediately
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    
                    // Show thinking indicator
                    showThinkingIndicator();
                    
                    const res = await fetch('/api/chat/', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken() || document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify(payload),
                    });
                    const data = await res.json();
                    
                    // Handle rate limit from backend
                    if (res.status === 429) {
                        hideThinkingIndicator();
                        appendMessage({ 
                            sender: 'bot', 
                            text: `⏱️ ${data.error || 'Please wait before sending another message.'}` 
                        });
                        // Update last message time to prevent bypass
                        lastMessageTime = Date.now();
                        if (data.retry_after) {
                            startCooldownTimer();
                        }
                        return;
                    }
                    
                    if (!res.ok || data.error) throw new Error(data.error || `HTTP ${res.status}`);

                    // Hide thinking indicator
                    hideThinkingIndicator();

                    // Show user emotions (from service) on the last user message bubble
                    const lastUser = chatMessages.querySelector('.chat-message.user-chat:last-of-type');
                    if (lastUser && data.emotions && data.emotions.length) {
                        const emoDiv = document.createElement('div');
                        emoDiv.className = 'message-emotions';
                        emoDiv.innerHTML = data.emotions.slice(0,3).map(e => `<span class='emotion-pill'>${e.label} ${(e.score||0).toFixed(2)}</span>`).join('');
                        lastUser.querySelector('.message-content').appendChild(emoDiv);
                    }

                    appendMessage({ sender: 'bot', text: data.reply });
                    
                    // Update last message time AFTER successful response
                    lastMessageTime = Date.now();
                    
                    // Update context panel
                    if (summaryEl) summaryEl.textContent = data.summary || '';
                    if (memoryEl) memoryEl.innerHTML = renderMemory(data.memory);
                } catch (err) {
                    hideThinkingIndicator();
                    appendMessage({ sender: 'bot', text: `Sorry, I hit an error: ${err.message}` });
                } finally {
                    // Start cooldown timer AFTER AI response (or error)
                    startCooldownTimer();
                    messageInput.focus();
                }
            }

            // Consent Management Functions
            async function checkConsentStatus() {
                try {
                    const response = await fetch('/api/consent/status/', {
                        method: 'GET',
                        headers: { 
                            'X-CSRFToken': getCSRFToken(),
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    consentStatus = data.consent_status;
                    updateConsentUI();
                    return consentStatus;
                } catch (error) {
                    console.error('Error checking consent status:', error);
                    // Set to null if there's an error, which will show "Set Privacy"
                    consentStatus = null;
                    updateConsentUI();
                    return null;
                }
            }

            function updateConsentUI() {
                // Update desktop consent status button
                if (consentStatusElement) {
                    if (consentStatus === true) {
                        consentStatusElement.innerHTML = '<span class="consent-indicator secure">🛡️ Secure</span>';
                        consentStatusElement.title = 'Data stored securely with encryption';
                    } else if (consentStatus === false) {
                        consentStatusElement.innerHTML = '<span class="consent-indicator ephemeral">👤 Private</span>';
                        consentStatusElement.title = 'Ephemeral mode - no data stored';
                    } else {
                        consentStatusElement.innerHTML = '<span class="consent-indicator unknown">⚙️ Set Privacy</span>';
                        consentStatusElement.title = 'Click to set your privacy preference';
                    }
                }

                // Update mobile menu consent text
                const mobileConsentText = document.getElementById('mobile-consent-text');
                if (mobileConsentText) {
                    if (consentStatus === true) {
                        mobileConsentText.textContent = 'Storage: Secure';
                    } else if (consentStatus === false) {
                        mobileConsentText.textContent = 'Storage: Private';
                    } else {
                        mobileConsentText.textContent = 'Storage Settings';
                    }
                }

                // Update ephemeral warning visibility
                if (ephemeralWarning) {
                    ephemeralWarning.style.display = (consentStatus === false) ? 'flex' : 'none';
                }
            }

            function showConsentModal() {
                if (consentModal && consentOverlay) {
                    // Reset selection
                    selectedConsent = consentStatus;
                    updateConsentSelection();
                    
                    consentModal.classList.add('show');
                    consentOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }

            function hideConsentModal() {
                if (consentModal && consentOverlay) {
                    consentModal.classList.remove('show');
                    consentOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                    selectedConsent = null;
                }
            }

            function updateConsentSelection() {
                consentOptions.forEach(option => {
                    const isSelected = option.dataset.consent === String(selectedConsent);
                    option.classList.toggle('selected', isSelected);
                });
            }

            async function updateConsent(consent) {
                try {
                    const response = await fetch('/api/consent/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({ consent })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        consentStatus = consent;
                        updateConsentUI();
                        hideConsentModal();
                        
                        // Show feedback message
                        const feedback = consent ? 
                            'Privacy setting updated: Secure storage enabled' : 
                            'Privacy setting updated: Ephemeral mode enabled';
                        appendMessage({ sender: 'system', text: feedback });
                        
                        return true;
                    } else {
                        throw new Error('Failed to update consent');
                    }
                } catch (error) {
                    console.error('Error updating consent:', error);
                    appendMessage({ sender: 'system', text: 'Error updating privacy setting. Please try again.' });
                    return false;
                }
            }

            function getCSRFToken() {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        return value;
                    }
                }
                return '';
            }

            // Send button click
            if (sendBtn) {
                sendBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const message = messageInput.value.trim();
                    if (message && !sendBtn.disabled) {
                        sendMessage(message);
                    }
                    return false;
                });
            }

            // Enter to send (Shift+Enter for new line)  
            if (messageInput) {
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        e.stopPropagation();
                        const message = messageInput.value.trim();
                        if (message && !sendBtn.disabled) {
                            sendMessage(message);
                        }
                        return false;
                    }
                });
            }

            // Clear intro message when user starts chatting
            function clearIntroMessage() {
                const introMessage = chatMessages.querySelector('.intro-message');
                if (introMessage) {
                    introMessage.remove();
                }
            }

            // New chat functionality
            async function startNewChat() {
                try {
                    const res = await fetch('/api/chat/new/', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                        },
                        credentials: 'same-origin'
                    });
                    const data = await res.json();
                    if (!res.ok || data.error) throw new Error(data.error || `HTTP ${res.status}`);
                    
                    // Clear current chat
                    chatMessages.innerHTML = `
                        <div class="intro-message">
                            <div class="intro-content">
                                <div class="intro-header">
                                    <span class="intro-avatar">🍄</span>
                                    <span class="intro-name">EnokiAI</span>
                                </div>
                                <div class="intro-text">
                                    Hello! I'm EnokiAI, your mental health companion. I'm here to listen, support, and help you navigate your thoughts and feelings in a safe, non-judgmental space.
                                </div>
                                <div class="intro-features">
                                    <h4>What I can help with:</h4>
                                    <ul>
                                        <li>Active listening and emotional support</li>
                                        <li>Stress management techniques</li>
                                        <li>Mindfulness and coping strategies</li>
                                        <li>General mental wellness guidance</li>
                                    </ul>
                                </div>
                                <div class="intro-text" style="margin-top: 1rem; font-style: italic; font-size: 0.9rem; color: #718096;">
                                    Remember: I'm here to support you, but I'm not a replacement for professional mental health care. If you're experiencing a crisis, please reach out to a mental health professional or crisis helpline.
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Update context
                    if (summaryEl) summaryEl.textContent = '';
                    if (memoryEl) memoryEl.innerHTML = '<em>No memory yet.</em>';
                    
                    console.log('New chat started:', data.session_id);
                } catch (err) {
                    console.error('Error starting new chat:', err);
                    alert('Failed to start new chat. Please try again.');
                }
            }

            // Load chat history
            async function loadChatHistory() {
                try {
                    const res = await fetch('/api/chat/history/', {
                        credentials: 'same-origin'
                    });
                    const data = await res.json();
                    if (!res.ok || data.error) throw new Error(data.error || `HTTP ${res.status}`);
                    
                    renderChatHistory(data.sessions);
                } catch (err) {
                    console.error('Error loading chat history:', err);
                    chatSessionsList.innerHTML = '<p style="color: #718096; text-align: center; padding: 2rem;">Failed to load chat history</p>';
                }
            }

            // Render chat history
            function renderChatHistory(sessions) {
                if (!sessions || sessions.length === 0) {
                    chatSessionsList.innerHTML = '<p style="color: #718096; text-align: center; padding: 2rem;">No chat history yet</p>';
                    return;
                }

                chatSessionsList.innerHTML = sessions.map(session => `
                    <div class="chat-session ${session.is_current ? 'active' : ''}" data-session-id="${session.id}">
                        <div class="session-header">
                            <div class="session-title">${session.title || 'Chat Session'}</div>
                            <button class="session-delete-btn" data-session-id="${session.id}" title="Delete chat">
                                🗑️
                            </button>
                        </div>
                        <div class="session-preview">${session.preview || 'No messages yet'}</div>
                        <div class="session-meta">
                            <span>${session.message_count} messages</span>
                            <span>${formatDate(session.updated_at)}</span>
                        </div>
                    </div>
                `).join('');

                // Add click handlers for session selection
                document.querySelectorAll('.chat-session').forEach(sessionEl => {
                    sessionEl.addEventListener('click', function(e) {
                        // Don't load session if clicking delete button
                        if (e.target.classList.contains('session-delete-btn')) {
                            return;
                        }
                        const sessionId = this.dataset.sessionId;
                        loadChatSession(sessionId);
                    });
                });

                // Add click handlers for delete buttons
                document.querySelectorAll('.session-delete-btn').forEach(deleteBtn => {
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // Prevent session loading
                        const sessionId = this.dataset.sessionId;
                        deleteChatSession(sessionId);
                    });
                });
            }

            // Delete chat session
            async function deleteChatSession(sessionId) {
                if (!confirm('Are you sure you want to delete this chat? This action cannot be undone.')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/chat/delete/${sessionId}/`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        throw new Error('Failed to delete chat session');
                    }

                    const data = await response.json();
                    
                    // If the deleted session was the current one, reload the page to start a new session
                    if (data.was_current_session) {
                        window.location.reload();
                    } else {
                        // Otherwise, just refresh the history list
                        loadChatHistory();
                    }
                } catch (error) {
                    console.error('Error deleting chat session:', error);
                    alert('Failed to delete chat session. Please try again.');
                }
            }

            // Load specific chat session
            async function loadChatSession(sessionId) {
                try {
                    // First, switch to this session on the backend
                    const switchRes = await fetch(`/api/chat/switch/${sessionId}/`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                        },
                        credentials: 'same-origin'
                    });
                    const switchData = await switchRes.json();
                    if (!switchRes.ok || switchData.error) throw new Error(switchData.error || `HTTP ${switchRes.status}`);
                    
                    // Now get the session details
                    const res = await fetch(`/api/chat/session/${sessionId}/`, {
                        credentials: 'same-origin'
                    });
                    const data = await res.json();
                    if (!res.ok || data.error) throw new Error(data.error || `HTTP ${res.status}`);
                    
                    // Clear current chat and load session messages
                    chatMessages.innerHTML = '';
                    data.messages.forEach(message => {
                        appendMessage({
                            sender: message.sender,
                            text: message.text,
                            emotions: message.emotions,
                            timeStr: formatTime(message.created_at)
                        });
                    });
                    
                    // Update context
                    if (summaryEl) summaryEl.textContent = data.summary || '';
                    if (memoryEl) memoryEl.innerHTML = renderMemory(data.memory);
                    
                    // Close history panel
                    closeHistoryPanel();
                    
                    console.log('Loaded chat session:', sessionId);
                } catch (err) {
                    console.error('Error loading chat session:', err);
                    alert('Failed to load chat session. Please try again.');
                }
            }

            // Format date for display
            function formatDate(dateStr) {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return 'Yesterday';
                if (diffDays < 7) return `${diffDays} days ago`;
                return date.toLocaleDateString();
            }

            // Format time for message display
            function formatTime(dateStr) {
                return new Date(dateStr).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            // Refresh context button
            if (refreshBtn) refreshBtn.addEventListener('click', function() {
                fetchContext();
            });

            // New chat button
            if (newChatBtn) newChatBtn.addEventListener('click', function() {
                if (confirm('Start a new chat? Your current conversation will be saved to history.')) {
                    startNewChat();
                }
            });

            // Initial behaviors
            scrollToBottom();
            fetchContext();
            checkConsentStatus();
        });
    </script>
</body>
</html>